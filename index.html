<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>QR Send - E2E Encrypted</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.4/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    
    <style>
        /* ... (Aapka saara CSS code waisa hi rahega) ... */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-card: #ffffff;
            --text-primary: #1a1a1a;
            --text-secondary: #666666;
            --accent: #4285f4;
            --accent-hover: #3367d6;
            --border: #e0e0e0;
            --shadow: rgba(0, 0, 0, 0.1);
            --success: #34a853;
            --error: #ea4335;
        }

        body.dark-mode {
            --bg-primary: #0f0f0f;
            --bg-secondary: #1a1a1a;
            --bg-card: #1e1e1e;
            --text-primary: #e8e8e8;
            --text-secondary: #b0b0b0;
            --border: #333333;
            --shadow: rgba(255, 255, 255, 0.05);
        }

        body {
            font-family: 'Google Sans', 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px;
            transition: all 0.3s ease;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, var(--accent) 1px, transparent 1px);
            background-size: 50px 50px;
            opacity: 0.03;
            animation: bgMove 20s linear infinite;
            z-index: 0;
        }

        @keyframes bgMove {
            0% { transform: translate(0, 0); }
            100% { transform: translate(50px, 50px); }
        }

        .theme-toggle {
            position: fixed;
            top: 15px;
            right: 15px;
            width: 45px;
            height: 45px;
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1000;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px var(--shadow);
        }

        .theme-toggle:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 8px 20px var(--shadow);
        }

        .theme-toggle svg {
            width: 22px;
            height: 22px;
            fill: var(--text-primary);
            transition: all 0.3s ease;
        }

        .watermark {
            position: fixed;
            bottom: 15px;
            right: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            opacity: 0.4;
            z-index: 1000;
            transition: opacity 0.3s ease;
        }

        .watermark:hover {
            opacity: 0.8;
        }

        .e2e-icon {
            width: 28px;
            height: 28px;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.4; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.1); }
        }

        .watermark-text {
            font-size: 9px;
            font-weight: 700;
            letter-spacing: 1px;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        .container {
            position: relative;
            max-width: 450px;
            width: 100%;
            background: var(--bg-card);
            border-radius: 20px;
            box-shadow: 
                0 10px 40px var(--shadow),
                0 0 0 1px var(--border);
            overflow: hidden;
            transform-style: preserve-3d;
            perspective: 1000px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1;
            max-height: 95vh;
            overflow-y: auto;
        }

        .container:hover {
            transform: translateY(-5px);
            box-shadow: 
                0 20px 60px var(--shadow),
                0 0 0 1px var(--border);
        }

        .container::-webkit-scrollbar {
            width: 6px;
        }

        .container::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        .container::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 3px;
        }

        header {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
            padding: 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        h1 {
            font-size: 22px;
            font-weight: 600;
            color: white;
            margin-bottom: 6px;
            letter-spacing: -0.5px;
        }

        #status {
            font-size: 13px;
            color: rgba(255,255,255,0.9);
            font-weight: 500;
        }

        .connection-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(10px);
        }

        .connection-overlay.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .lock-animation {
            position: relative;
            animation: lockBounce 1s ease-in-out;
        }

        @keyframes lockBounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        .lock-svg {
            width: 100px;
            height: 100px;
        }

        .lock-body {
            animation: lockClose 0.8s ease forwards;
        }

        @keyframes lockClose {
            0% { opacity: 0; transform: translateY(20px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        .lock-shackle {
            animation: shackleClose 0.8s ease forwards 0.3s;
        }

        @keyframes shackleClose {
            0% { transform: translateY(-10px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }

        .checkmark {
            animation: checkmarkDraw 0.5s ease forwards 1s;
        }

        @keyframes checkmarkDraw {
            0% { stroke-dashoffset: 100; opacity: 0; }
            100% { stroke-dashoffset: 0; opacity: 1; }
        }

        main {
            padding: 20px;
        }

        #qr-code-container {
            text-align: center;
        }

        #qrcode {
            display: inline-block;
            padding: 15px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 16px var(--shadow);
            margin-bottom: 15px;
            transition: transform 0.3s ease;
        }

        #qrcode:hover {
            transform: scale(1.03);
        }

        #qrcode canvas,
        #qrcode img {
            max-width: 100%;
            height: auto !important;
            width: auto !important;
        }

        #qr-code-container p {
            color: var(--text-secondary);
            font-size: 13px;
            margin-bottom: 12px;
        }

        #share-buttons-container {
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .share-button {
            padding: 10px 18px;
            border: 2px solid var(--border);
            background: var(--bg-card);
            color: var(--text-primary);
            border-radius: 10px;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .share-button:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(66, 133, 244, 0.3);
        }

        .primary-share {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .scanner-button {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }

        .scanner-button:hover {
            background: #2d8e47;
            border-color: #2d8e47;
        }

        .scanner-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000000;
            display: none;
            flex-direction: column;
            z-index: 10000;
            padding: 0;
        }

        .scanner-modal.active {
            display: flex;
        }

        .scanner-header {
            background: rgba(0, 0, 0, 0.9);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 10001;
        }

        .scanner-header h2 {
            font-size: 18px;
            color: white;
            font-weight: 600;
        }

        .close-scanner {
            background: var(--error);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .close-scanner:hover {
            background: #c82333;
            transform: scale(1.1);
        }

        #qr-reader {
            width: 100% !important;
            height: calc(100vh - 70px) !important;
            position: relative;
            background: #000;
        }

        #qr-reader video {
            width: 100% !important;
            height: 100% !important;
            object-fit: cover !important;
            position: absolute !important;
            top: 0 !important;
            left: 0 !important;
        }

        #qr-reader__dashboard,
        #qr-reader__dashboard_section {
            display: none !important;
        }

        #qr-reader__scan_region {
            width: 100% !important;
            height: 100% !important;
            position: relative !important;
            border: none !important;
        }

        .scan-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            max-width: 350px;
            height: 80%;
            max-height: 350px;
            border: 3px solid var(--success);
            border-radius: 20px;
            z-index: 10000;
            pointer-events: none;
            box-shadow: 
                0 0 0 2000px rgba(0, 0, 0, 0.5),
                inset 0 0 30px rgba(52, 168, 83, 0.3);
        }

        .scan-line {
            position: absolute;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--success), transparent);
            animation: scan 2s linear infinite;
        }

        @keyframes scan {
            0% { top: 0; }
            100% { top: 100%; }
        }

        .scan-corners {
            position: absolute;
            width: 100%;
            height: 100%;
        }

        .corner {
            position: absolute;
            width: 30px;
            height: 30px;
            border: 4px solid var(--success);
        }

        .corner.top-left {
            top: -3px;
            left: -3px;
            border-right: none;
            border-bottom: none;
            border-radius: 20px 0 0 0;
        }

        .corner.top-right {
            top: -3px;
            right: -3px;
            border-left: none;
            border-bottom: none;
            border-radius: 0 20px 0 0;
        }

        .corner.bottom-left {
            bottom: -3px;
            left: -3px;
            border-right: none;
            border-top: none;
            border-radius: 0 0 0 20px;
        }

        .corner.bottom-right {
            bottom: -3px;
            right: -3px;
            border-left: none;
            border-top: none;
            border-radius: 0 0 20px 0;
        }

        .scan-instruction {
            position: absolute;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 25px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            z-index: 10001;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        #scan-instructions {
            text-align: center;
            animation: slideUp 0.5s ease;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        #scan-instructions p {
            font-size: 16px;
            color: var(--success);
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        #scan-instructions p::before {
            content: 'ğŸ”’';
            font-size: 20px;
            animation: rotate 2s linear infinite;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .transfer-area {
            padding: 20px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
        }

        .transfer-area h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        #file-input {
            width: 100%;
            padding: 12px;
            border: 2px dashed var(--border);
            border-radius: 10px;
            background: var(--bg-card);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
            font-size: 13px;
        }

        #file-input:hover {
            border-color: var(--accent);
            background: var(--accent);
            color: white;
        }

        #transfer-status {
            margin-top: 12px;
            font-size: 13px;
            color: var(--text-secondary);
            text-align: center;
        }

        .progress-container {
            margin-top: 15px;
            padding: 15px;
            background: var(--bg-card);
            border-radius: 10px;
            box-shadow: 0 2px 8px var(--shadow);
            display: none;
        }

        .progress-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .progress-bar-background {
            position: relative;
            width: 100%;
            height: 35px;
            background: var(--bg-secondary);
            border-radius: 18px;
            overflow: visible;
            box-shadow: inset 0 2px 4px var(--shadow);
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent) 0%, var(--success) 100%);
            border-radius: 18px;
            transition: width 0.3s ease;
            position: relative;
            box-shadow: 0 2px 8px rgba(66, 133, 244, 0.3);
        }

        .delivery-boy {
            position: absolute;
            right: -45px;
            top: 50%;
            transform: translateY(-50%);
            width: 35px;
            height: 35px;
            transition: right 0.3s ease;
            z-index: 10;
        }

        .delivery-boy svg {
            width: 100%;
            height: 100%;
            animation: bounce 0.5s ease-in-out infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-4px); }
        }

        .progress-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 11px;
            color: var(--text-secondary);
        }

        #cancel-button {
            margin-top: 12px;
            width: 100%;
            padding: 10px;
            background: var(--error);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        #cancel-button:hover {
            background: #d33828;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(234, 67, 53, 0.3);
        }

        .switch-mode-button {
            margin-top: 12px;
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
            color: #000;
            border: none;
            border-radius: 10px;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
        }

        .switch-mode-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 193, 7, 0.4);
        }

        @media (max-width: 600px) {
            body {
                padding: 10px;
            }

            .container {
                border-radius: 16px;
                max-height: 98vh;
            }

            h1 {
                font-size: 20px;
            }

            #status {
                font-size: 12px;
            }

            .theme-toggle {
                width: 40px;
                height: 40px;
                top: 10px;
                right: 10px;
            }

            .scan-indicator {
                width: 85%;
                height: 85%;
            }

            .scan-instruction {
                bottom: 80px;
                font-size: 14px;
                padding: 12px 20px;
            }
        }

        @media (min-width: 601px) and (max-width: 1024px) {
            .container {
                max-width: 420px;
            }

            #qrcode canvas,
            #qrcode img {
                max-width: 220px !important;
            }
        }

        @media (min-width: 1025px) {
            #qrcode canvas,
            #qrcode img {
                max-width: 200px !important;
            }
        }
    </style>
</head>
<body>
    <div class="theme-toggle" onclick="toggleTheme()">
 Â  Â  Â  Â  <svg id="theme-icon-light" viewBox="0 0 24 24" style="display: none;">
 Â  Â  Â  Â  Â  Â  <path d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round" fill="none"/>
 Â  Â  Â  Â  </svg>
 Â  Â  Â  Â  <svg id="theme-icon-dark" viewBox="0 0 24 24">
 Â  Â  Â  Â  Â  Â  <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" fill="currentColor"/>
 Â  Â  Â  Â  </svg>
 Â  Â  </div>

 Â  Â  <div class="watermark">
 Â  Â  Â  Â  <svg class="e2e-icon" viewBox="0 0 24 24" fill="currentColor">
 Â  Â  Â  Â  Â  Â  <path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/>
 Â  Â  Â  Â  </svg>
 Â  Â  Â  Â  <span class="watermark-text">Anonymous</span>
 Â  Â  </div>

 Â  Â  <div class="connection-overlay" id="connection-overlay">
 Â  Â  Â  Â  <div class="lock-animation">
 Â  Â  Â  Â  Â  Â  <svg class="lock-svg" viewBox="0 0 100 100">
 Â  Â  Â  Â  Â  Â  Â  Â  <defs>
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <linearGradient id="lockGradient" x1="0%" y1="0%" x2="100%" y2="100%">
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <stop offset="0%" style="stop-color:#4285f4;stop-opacity:1" />
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <stop offset="100%" style="stop-color:#34a853;stop-opacity:1" />
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </linearGradient>
 Â  Â  Â  Â  Â  Â  Â  Â  </defs>
 Â  Â  Â  Â  Â  Â  Â  Â  <rect class="lock-body" x="30" y="45" width="40" height="35" rx="5" fill="url(#lockGradient)"/>
 Â  Â  Â  Â  Â  Â  Â  Â  <path class="lock-shackle" d="M35 45 V35 C35 25 40 20 50 20 C60 20 65 25 65 35 V45" 
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  stroke="url(#lockGradient)" stroke-width="5" fill="none" stroke-linecap="round"/>
 Â  Â  Â  Â  Â  Â  Â  Â  <circle cx="50" cy="60" r="4" fill="white"/>
 Â  Â  Â  Â  Â  Â  Â  Â  <rect x="48" y="60" width="4" height="8" fill="white"/>
 Â  Â  Â  Â  Â  Â  Â  Â  <polyline class="checkmark" points="40,62 47,69 62,54" 
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  stroke="#34a853" stroke-width="4" fill="none" 
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  stroke-linecap="round" stroke-linejoin="round"
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  stroke-dasharray="100" stroke-dashoffset="100"/>
 Â  Â  Â  Â  Â  Â  </svg>
 Â  Â  Â  Â  Â  Â  <p style="color: white; margin-top: 15px; font-size: 16px; font-weight: 600;">
 Â  Â  Â  Â  Â  Â  Â  Â  ğŸ” E2E Encrypted Connection
 Â  Â  Â  Â  Â  Â  </p>
 Â  Â  Â  Â  </div>
 Â  Â  </div>

 Â  Â  <div class="scanner-modal" id="scanner-modal">
 Â  Â  Â  Â  <div class="scanner-header">
 Â  Â  Â  Â  Â  Â  <h2>ğŸ“· Scan QR Code</h2>
 Â  Â  Â  Â  Â  Â  <button class="close-scanner" onclick="closeScanner()">âœ•</button>
 Â  Â  Â  Â  </div>
 Â  Â  Â  Â  <div id="qr-reader"></div>
 Â  Â  Â  Â  
 Â  Â  Â  Â  <div class="scan-indicator">
 Â  Â  Â  Â  Â  Â  <div class="scan-line"></div>
 Â  Â  Â  Â  Â  Â  <div class="scan-corners">
 Â  Â  Â  Â  Â  Â  Â  Â  <div class="corner top-left"></div>
 Â  Â  Â  Â  Â  Â  Â  Â  <div class="corner top-right"></div>
 Â  Â  Â  Â  Â  Â  Â  Â  <div class="corner bottom-left"></div>
 Â  Â  Â  Â  Â  Â  Â  Â  <div class="corner bottom-right"></div>
 Â  Â  Â  Â  Â  Â  </div>
 Â  Â  Â  Â  </div>
 Â  Â  Â  Â  
 Â  Â  Â  Â  <div class="scan-instruction">
 Â  Â  Â  Â  Â  Â  ğŸ“± Point camera at QR code
 Â  Â  Â  Â  </div>
 Â  Â  </div>
    
    <div class="container">
        <header>
            <h1>QR Send Pro</h1>
            <div id="status">Starting...</div>
        </header>
        
 Â  Â  Â  Â  <main>
 Â  Â  Â  Â  Â  Â  <div id="qr-code-container">
 Â  Â  Â  Â  Â  Â  Â  Â  <div id="qrcode"></div>
 Â  Â  Â  Â  Â  Â  Â  Â  <p>Scan QR code to connect securely</p>
 Â  Â  Â  Â  Â  Â  Â  Â  
 Â  Â  Â  Â  Â  Â  Â  Â  <div id="share-buttons-container">
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="native-share-button" class="share-button primary-share" style="display: none;">ğŸ“¤ Share</button>
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="copy-link-button" class="share-button">ğŸ“‹ Copy</button>
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="download-qr-button" class="share-button">ğŸ’¾ Save</button>
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="scan-qr-button" class="share-button scanner-button" onclick="openScanner()">ğŸ“· Scan</button>
 Â  Â  Â  Â  Â  Â  Â  Â  </div>
 Â  Â  Â  Â  Â  Â  </div>

 Â  Â  Â  Â  Â  Â  <div id="scan-instructions" style="display:none;">
 Â  Â  Â  Â  Â  Â  Â  Â  <p>âœ… Connected Securely!</p>
 Â  Â  Â  Â  Â  Â  </div>
 Â  Â  Â  Â  </main>

 Â  Â  Â  Â  <div class="transfer-area">
 Â  Â  Â  Â  Â  Â  <h3>ğŸ“ Send Files</h3>
 Â  Â  Â  Â  Â  Â  <input type="file" id="file-input" disabled multiple>
 Â  Â  Â  Â  Â  Â  <div id="transfer-status">Waiting...</div>

 Â  Â  Â  Â  Â  Â  <div id="progress-container" class="progress-container">
 Â  Â  Â  Â  Â  Â  Â  Â  <div class="progress-label">
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>Sending...</span>
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="progress-percentage">0%</span>
 Â  Â  Â  Â  Â  Â  Â  Â  </div>
 Â  Â  Â  Â  Â  Â  Â  Â  <div class="progress-bar-background">
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="progress-bar" class="progress-bar">
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="delivery-boy" id="delivery-boy">
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg viewBox="0 0 64 64">
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <circle cx="20" cy="45" r="8" fill="#333"/>
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <circle cx="44" cy="45" r="8" fill="#333"/>
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <path d="M10 35 L20 35 L25 25 L45 25 L50 35 L54 35 L54 45 L10 45 Z" fill="#4285f4"/>
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <rect x="30" y="20" width="15" height="10" fill="#ea4335" rx="2"/>
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <circle cx="37" cy="15" r="5" fill="#fbbc04"/>
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </svg>
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
 Â  Â  Â  Â  Â  Â  Â  Â  </div>
 Â  Â  Â  Â  Â  Â  Â  Â  <div class="progress-stats">
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="progress-size">0 MB / 0 MB</span>
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="progress-eta">ETA: --:--</span>
 Â  Â  Â  Â  Â  Â  Â  Â  </div>
 Â  Â  Â  Â  Â  Â  Â  Â  <button id="cancel-button">âŒ Cancel</button>
 Â  Â  Â  Â  Â  Â  </div>
 Â  Â  Â  Â  Â  Â  
 Â  Â  Â  Â  Â  Â  <div id="receive-progress-container" class="progress-container">
 Â  Â  Â  Â  Â  Â  Â  Â  <div class="progress-label">
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>Receiving...</span>
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="receive-progress-percentage">0%</span>
 Â  Â  Â  Â  Â  Â  Â  Â  </div>
 Â  Â  Â  S Â  Â  Â  Â  Â  <div class="progress-bar-background">
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="receive-progress-bar" class="progress-bar"></div>
 Â  Â  Â  Â  Â  Â  Â  Â  </div>
 Â  Â  Â  Â  Â  Â  Â  Â  <div class="progress-stats">
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="receive-progress-size">0 MB / 0 MB</span>
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>ğŸ” Encrypted</span>
 Â  Â  Â  Â  Â  Â  Â  Â  </div>
 Â  Â  Â  Â  Â  Â  </div>
 Â  Â  Â  Â  </div>
    </div>

    <script>
        // --- YAHAN SE FIX SHURU HUA ---
        // Missing Global Functions aur Variables
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            document.getElementById('theme-icon-light').style.display = isDark ? 'block' : 'none';
            document.getElementById('theme-icon-dark').style.display = isDark ? 'none' : 'block';
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        }

        if (localStorage.getItem('theme') === 'dark') {
            toggleTheme();
        }

        let html5QrCode = null;
        let isScanning = false;
        let hasScanned = false;
        // This flag blocks peer init *while scanning* to prevent race conditions
        let ALLOW_PEER_INIT = true;
        // This flag prevents reload loops on disconnect
        let IS_RELOADING = false; 

        window.APP_PEER = null;
        window.APP_CONNECTION = null;
        let NOTIFICATION_PERMISSION = 'default';

        /**
         * Notification Permission Functions
         */
        function requestNotificationPermission() {
            if (!('Notification' in window)) {
                console.log("This browser does not support desktop notification");
                return;
            }

            Notification.requestPermission().then((permission) => {
                NOTIFICATION_PERMISSION = permission;
                console.log('Notification Permission:', permission);
            });
        }

        /**
         * Shows a browser notification.
         * Uses a 'tag' to replace existing notifications for progress updates.
         */
        function showNotification(title, options) {
            if (NOTIFICATION_PERMISSION !== 'granted') {
                return; // Permission not granted
            }
            
            // 'tag' ensures that new notifications with the same tag replace old ones
            // 'renotify' and 'silent' are good for progress updates to avoid sound
            new Notification(title, { 
                ...options, 
                tag: 'file-transfer-progress',
                silent: true,
                renotify: false // Set to false to avoid re-alerting on updates
            });
        }

        function openScanner() {
            // ADDED GUARD: If scanner modal is already active or we are scanning, do nothing.
            if (isScanning || document.getElementById('scanner-modal').classList.contains('active')) {
                console.log('âš  openScanner called but scanner is already active. Ignoring.');
                return;
            }
            console.log('ğŸ“· Opening scanner...');
            hasScanned = false;
            // Block peer auto-init *before* starting scanner
            ALLOW_PEER_INIT = false; 
            console.log('ğŸš« BLOCKED peer auto-init');
            document.getElementById('scanner-modal').classList.add('active');
            document.body.style.overflow = 'hidden';
            startScanner();
        }

        function closeScanner() {
            // ADDED GUARD: Don't do anything if already closing
            if (!document.getElementById('scanner-modal').classList.contains('active')) {
                console.log('âš  closeScanner called but modal is already closed.');
                return;
            }
            console.log('âŒ Closing scanner...');
            document.getElementById('scanner-modal').classList.remove('active');
            document.body.style.overflow = '';
            stopScanner(); // This is now the only place that calls stopScanner after a scan
            // Re-allow peer init *only if* no scan was successful (and we are not reloading)
            if (!hasScanned && !IS_RELOADING) {
                ALLOW_PEER_INIT = true;
                console.log('âœ… RE-ENABLED peer auto-init');
            }
        }

        function startScanner() {
            if (html5QrCode || isScanning) {
                console.log('âš  Scanner already running');
                return;
            }
            isScanning = true;
            console.log('ğŸ¥ Starting camera...');

            html5QrCode = new Html5Qrcode("qr-reader");
            
            const config = {
                fps: 30,
                qrbox: function(viewfinderWidth, viewfinderHeight) {
                    let minDimension = Math.min(viewfinderWidth, viewfinderHeight);
                    let qrboxSize = Math.floor(minDimension * 0.8);
                    return { width: qrboxSize, height: qrboxSize };
                },
                aspectRatio: 1.0,
                disableFlip: false
            };
            
            html5QrCode.start(
                { facingMode: "environment" },
                config,
                (decodedText) => {
                    if (hasScanned) {
                        console.log('âš  Already processed, ignoring...');
                        return;
                    }
                    hasScanned = true;
                    // ALLOW_PEER_INIT remains false, which is correct
                    
                    console.log('âœ“âœ“âœ“ QR SCANNED:', decodedText);
                    
                    if (navigator.vibrate) {
                        navigator.vibrate(200);
                    }
                    
                    setTimeout(() => {
                        console.log('â†’ Calling processQRCode NOW (from timeout)...');
                        processQRCode(decodedText);

                        console.log('â†’ Calling closeScanner NOW (from timeout)...');
                        closeScanner();
                    }, 0); // 0ms timeout executes after current stack.
                },
                (errorMessage) => {
                    // Silent
                }
            ).catch((err) => {
                console.error('âŒ Scanner error:', err);
                isScanning = false;
                // Allow peer init to recover if camera fails
                ALLOW_PEER_INIT = true; 
                alert('Camera error: ' + err.name);
                closeScanner();
            });
        }

        /**
         * UPDATED: This function now sets the URL hash and reloads the page.
         */
        function processQRCode(decodedText) {
            // ADDED GUARD: Prevent multiple reloads
            if (IS_RELOADING) {
                console.log('âš  Already processing QR and reloading. Ignoring.');
                return;
            }
            IS_RELOADING = true; // Set flag immediately

            console.log('=== PROCESSING QR CODE ===');
            console.log('URL:', decodedText);
            
            try {
                const url = new URL(decodedText);
                console.log('âœ“ Valid URL');
                console.log('Hash:', url.hash);
                
                const scannedPeerId = url.hash.substring(1);
                console.log('ğŸ¯ Extracted Peer ID:', scannedPeerId);
                
                if (!scannedPeerId || scannedPeerId.trim() === '') {
                    console.error('âŒ Empty peer ID!');
                    alert('QR code has no peer ID');
                    hasScanned = false; // Allow re-scan
                    ALLOW_PEER_INIT = true; // Allow peer init to recover
                    return;
                }
                
                console.log('âœ“ Peer ID is valid');
                
                // --- NEW LOGIC ---
                // Set the hash to the scanned ID and reload.
                // The app will re-initialize in client mode.
                console.log('ğŸ”„ Setting hash and reloading to switch to CLIENT mode...');
                window.location.hash = scannedPeerId;
                window.location.reload();
                
            } catch (e) {
                console.error('âŒâŒâŒ QR parse FAILED:', e);
                console.error('Error:', e.message);
                alert('Invalid QR code: ' + e.message);
                hasScanned = false; // Allow re-scan
                ALLOW_PEER_INIT = true; // Allow peer init to recover
                IS_RELOADING = false; // RESET FLAG on error
            }
        }

        function stopScanner() {
            if (html5QrCode && isScanning) {
                console.log('ğŸ›‘ Stopping scanner...');
                html5QrCode.stop().then(() => {
                    html5QrCode.clear();
                    html5QrCode = null;
                    isScanning = false;
                    console.log('âœ“ Scanner stopped');
                }).catch((err) => {
                    console.error('Stop error:', err);
                    html5QrCode = null;
                    isScanning = false;
                });
            }
        }

        function showConnectionAnimation() {
            const overlay = document.getElementById('connection-overlay');
            overlay.classList.add('active');
            setTimeout(() => {
                overlay.classList.remove('active');
            }, 2000);
        }

        function updateDeliveryBoy(percent) {
            const deliveryBoy = document.getElementById('delivery-boy');
            if (deliveryBoy) {
                const position = (percent / 100) * 100;
                deliveryBoy.style.right = `${-45 + position}%`;
            }
        }
        // --- YAHAN PAR FIX KHATM HUA ---
        
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸš€ App initialized');
            
            const statusEl = document.getElementById('status');
            // --- FIX: Missing Element Selectors ---
            const qrCodeContainer = document.getElementById('qr-code-container');
            const qrEl = document.getElementById('qrcode');
            const scanInstructions = document.getElementById('scan-instructions');
            const fileInput = document.getElementById('file-input');
            const transferStatusEl = document.getElementById('transfer-status');
            const shareButtonsContainer = document.getElementById('share-buttons-container');

            const nativeShareButton = document.getElementById('native-share-button');
            const copyLinkButton = document.getElementById('copy-link-button');
            const downloadQrButton = document.getElementById('download-qr-button');
            
            const progressContainer = document.getElementById('progress-container');
            const progressBar = document.getElementById('progress-bar');
            const progressPercentage = document.getElementById('progress-percentage');
            const progressSize = document.getElementById('progress-size');
            const progressEta = document.getElementById('progress-eta');
            const cancelButton = document.getElementById('cancel-button');
            
            const receiveProgressContainer = document.getElementById('receive-progress-container');
            const receiveProgressBar = document.getElementById('receive-progress-bar');
            const receiveProgressPercentage = document.getElementById('receive-progress-percentage');
            const receiveProgressSize = document.getElementById('receive-progress-size');
            // ---

            let peer = null;
            // --- FIX: Missing Variables ---
            const CHUNK_SIZE = 64 * 1024;
            let currentConnection = null;
            let myId = '';
            let connectUrl = '';
            let isHost = false; // This will be set by initializePeer
            let connectionRetryCount = 0;
            const MAX_RETRY = 3;
            
            let fileQueue = [];
            let isSending = false;
            let isReceiving = false;
            let cancelTransfer = false;
            let hasActiveTransfer = false;
            let heartbeatInterval = null;
            
            // Request notification permission on load
            requestNotificationPermission();

            window.addEventListener('beforeunload', (event) => {
                if (hasActiveTransfer || isSending || isReceiving) {
                    const warningText = 'Transfer active!';
                    event.preventDefault();
                    event.returnValue = warningText;
                    return warningText;
                }
            });
            // ---

            function initializePeer() {
                if (!ALLOW_PEER_INIT) {
                    console.log('ğŸš« Peer init BLOCKED (scanner active)');
                    return;
                }
                
                console.log('ğŸ”§ Initializing peer...');
                statusEl.textContent = 'Connecting Private Server...';
                
                try {
                    // --- !!! YEH SABSE ZAROORI BADLAV HAI !!! ---
                    // Yeh code *sirf* aapke private server se connect hoga.
                    // Yahaan koi fallback (public server) logic nahi hai.
                    
                    const peerOptions = {
                        // Niche ki 3 lines ko apni Render.com URL se bharein
                        // (Yeh URL aapko README guide ke Step 2 se milega)
                        
                        host: 'https://my-qr-signal.onrender.com', // <-- APNA LIVE URL YAHAN DAALEIN
                        port: 443,                                 // <-- HTTPS ke liye 443
                        secure: true,                              // <-- Isko TRUE karein

                        path: '/peerjs', // Yeh server.js ke path se match hona chahiye
                        config: {
                            iceServers: [
                                { urls: 'stun:stun.l.google.com:19302' },
                                { 
                                    urls: 'turn:openrelay.metered.ca:80',
                                    username: 'openrelayproject',
                                    credential: 'openrelayproject'
                                }
                            ]
                        },
                        debug: 1 // Shuruaat mein debug ke liye achha hai
                    };
                    
                    peer = new Peer(peerOptions);
                    
                    // --- !!! BADLAV KHATM !!! ---

                    window.APP_PEER = peer;
                    
                } catch (e) {
                    console.error('âŒ Init error:', e);
                    statusEl.textContent = 'âŒ Server Error';
                    return;
                }

                peer.on('open', (id) => {
                    myId = id;
                    console.log('âœ“ Peer ID:', id);
                    const targetId = window.location.hash.substring(1);

                    if (targetId) {
                        // --- FIX: Missing Client Mode Logic ---
                        console.log('â†’ CLIENT MODE');
                        isHost = false;
                        statusEl.textContent = 'ğŸ”— Connecting...';
                        qrCodeContainer.style.display = 'none'; // Hide QR
                        shareButtonsContainer.style.display = 'none'; // Hide buttons
                        scanInstructions.style.display = 'none';
                        attemptConnection(targetId);
                        // ---
                    } else {
                        // --- FIX: Missing Host Mode Logic ---
                        console.log('â†’ HOST MODE');
                        isHost = true;
                        qrCodeContainer.style.display = 'block';
                        scanInstructions.style.display = 'none';
                        
                        statusEl.textContent = 'Generating QR...';
                        
                        connectUrl = `${window.location.origin}${window.location.pathname}#${myId}`;
                        qrEl.innerHTML = '';
                        
                        new QRCode(qrEl, {
                            text: connectUrl,
                            width: 256,
                            height: 256,
                            colorDark: "#000000",
                            colorLight: "#ffffff",
                            correctLevel: QRCode.CorrectLevel.H
                        });
                        
                        shareButtonsContainer.style.display = 'flex';
                        setTimeout(setupShareButton, 100);
                        statusEl.textContent = 'âœ… Ready';
                        // ---
                    }
                });

                peer.on('connection', (conn) => {
                    // --- FIX: Missing Connection Logic ---
                    console.log('ğŸ“¡ Incoming connection');
                    if (currentConnection) {
                        console.log('âš  Already connected, rejecting new connection.');
                        conn.close();
                        return;
                    }
                    
                    statusEl.textContent = 'ğŸ“¡ Incoming...';
                    
                    if (conn.open) {
                        setupConnection(conn);
                    } else {
                        conn.on('open', () => setupConnection(conn));
                    }
                    // ---
                });

                peer.on('error', (err) => {
                    console.error('âŒ Peer error:', err.type);
                    // Yeh naya error logic hai (Hybrid model ke liye)
                    if (err.type === 'peer-unavailable' || err.type === 'server-error' || err.type === 'network') {
                        statusEl.textContent = 'âŒ Server Disconnected';
                        // Client mode mein 'Go to Host' button dikhayein
                        if (!isHost) showSwitchButton();
                    }
                });
            } 
            
            // --- FIX: Missing DOMContentLoaded Functions ---
            function showSwitchButton() {
                if (document.getElementById('switch-mode-btn')) return;
                
                const btn = document.createElement('button');
                btn.id = 'switch-mode-btn';
                btn.textContent = 'ğŸ”„ Go to Host Mode';
                btn.className = 'switch-mode-button';
                btn.onclick = () => {
                    btn.remove();
                    // Just clear hash and reload
                    window.location.hash = '';
                    window.location.reload();
                };
                document.querySelector('.transfer-area').appendChild(btn);
            }

            function attemptConnection(targetId) {
                console.log('â†’ Attempting connection to:', targetId);
                let connectionFailed = false;
                let connectionTimer = null;
                
                const handleFailure = (message) => {
                    if (connectionFailed) return;
                    connectionFailed = true;
                    if (connectionTimer) clearTimeout(connectionTimer);
                    console.error('âŒ Connection failed:', message);
                    
                    if (connectionRetryCount < MAX_RETRY) {
                        connectionRetryCount++;
                        statusEl.textContent = `ğŸ”„ Retry ${connectionRetryCount}`;
                        setTimeout(() => attemptConnection(targetId), 2000);
                    } else {
                        statusEl.textContent = 'âŒ Failed to connect';
                        showSwitchButton(); // Show button to go back
                    }
                };

                try {
                    connectionTimer = setTimeout(() => handleFailure('Timeout'), 20000);
                    
                    const conn = peer.connect(targetId, { 
                        reliable: true,
                        serialization: 'binary'
                    });

                    conn.on('open', () => {
                        console.log('âœ“âœ“âœ“ CONNECTION OPENED!');
                        clearTimeout(connectionTimer);
                        if (!connectionFailed) {
                            connectionRetryCount = 0;
                            setupConnection(conn);
                        }
                    });

                    conn.on('error', (err) => {
                        console.error('âŒ Connection error:', err);
                        handleFailure('Error');
                    });
                    
                    conn.on('close', () => {
                        console.log('âš  Connection closed early');
                        if (!currentConnection) handleFailure('Closed');
                    });
                } catch (e) {
                    console.error('âŒ Connect exception:', e);
                    handleFailure('Failed');
                }
            }

            function setupConnection(conn) {
                console.log('âœ“ Setup connection');
                currentConnection = conn;
                window.APP_CONNECTION = conn;
                showConnectionAnimation();
                
                statusEl.textContent = 'ğŸ” Connected!';
                fileInput.disabled = false;
                transferStatusEl.textContent = 'âœ… Ready';
                
                // Hide QR container and show "Connected" status
                qrCodeContainer.style.display = 'none';
                shareButtonsContainer.style.display = 'none';
                scanInstructions.style.display = 'block';
                
                const switchBtn = document.getElementById('switch-mode-btn');
                if (switchBtn) switchBtn.remove();
                
                if (isHost) startHeartbeat();
                
                let incomingFileData = [];
                let fileMetadata = {};
                let receivedBytes = 0;

                // Send a 'ready' signal to the other peer
                setTimeout(() => {
                    if (currentConnection && currentConnection.open) {
                        try {
                            currentConnection.send({ type: 'ready' });
                        } catch(e) {
                            console.error("Failed to send ready signal", e);
                        }
                    }
                }, 100);

                conn.on('data', (data) => {
                    if (data.type === 'ready') {
                        statusEl.textContent = 'âœ… Ready!';
                        return;
                    }
                    
                    if (data.type === 'heartbeat-ping') {
                        conn.send({ type: 'heartbeat-pong' });
                        return;
                    }
                    
                    if (data.type === 'heartbeat-pong') return;

                    if (data.type === 'metadata') {
                        fileMetadata = data;
                        incomingFileData = [];
                        receivedBytes = 0;
                        isReceiving = true;
                        hasActiveTransfer = true;
                        
                        transferStatusEl.textContent = `ğŸ“¥ ${fileMetadata.name}`;
                        receiveProgressContainer.style.display = 'block';
                        receiveProgressBar.style.width = '0%';
                        receiveProgressPercentage.textContent = '0%';
                        receiveProgressSize.textContent = `0 / ${formatBytes(fileMetadata.size)}`;

                        // Show notification
                        showNotification('Downloading...', {
                            body: `Receiving: ${fileMetadata.name}`,
                            icon: 'https://cdn-icons-png.flaticon.com/128/1828/1828770.png' // Download icon
                        });

                    } else if (data.type === 'end') {
                        const fileBlob = new Blob(incomingFileData, { type: fileMetadata.type });
                        const downloadUrl = URL.createObjectURL(fileBlob);
                        const a = document.createElement('a');
                        a.href = downloadUrl;
                        a.download = fileMetadata.name;
                        document.body.appendChild(a);
                        a.click();
                        a.remove();
                        setTimeout(() => URL.revokeObjectURL(downloadUrl), 100);
                        
                        transferStatusEl.textContent = `âœ… Received`;
                        receiveProgressContainer.style.display = 'none';
                        isReceiving = false;
                        hasActiveTransfer = false;
                        incomingFileData = [];

                        // Show notification
                        showNotification('Download Complete', {
                            body: fileMetadata.name,
                            icon: 'https://cdn-icons-png.flaticon.com/128/709/709664.png' // Checkmark icon
                        });

                    } else if (data.type === 'cancel') {
                        transferStatusEl.textContent = 'âŒ Cancelled by sender';
                        incomingFileData = [];
                        receiveProgressContainer.style.display = 'none';
                        isReceiving = false;
                        hasActiveTransfer = false;

                        // Show notification
                        showNotification('Download Cancelled', {
                            body: 'The sender cancelled the transfer.',
                            icon: 'https://cdn-icons-png.flaticon.com/128/1828/1828843.png' // Error icon
                        });

                    } else {
                        // This is a file chunk (ArrayBuffer)
                        incomingFileData.push(data);
                        receivedBytes += data.byteLength;
                        
                        const percent = Math.round((receivedBytes / fileMetadata.size) * 100);
                        receiveProgressBar.style.width = `${percent}%`;
                        receiveProgressPercentage.textContent = `${percent}%`;
                        receiveProgressSize.textContent = `${formatBytes(receivedBytes)} / ${formatBytes(fileMetadata.size)}`;
                    
                        // Update notification (throttled to every 10%)
                        if (percent % 10 === 0) {
                            showNotification('Downloading...', {
                                body: `${fileMetadata.name} (${percent}%)`,
                                icon: 'https://cdn-icons-png.flaticon.com/128/1828/1828770.png'
                            });
                        }
                    }
                });

                conn.on('close', () => handleDisconnect('Closed'));
                conn.on('error', (err) => {
                    console.error("Connection error:", err);
                    handleDisconnect('Error');
                });
                
                if (fileQueue.length > 0 && !isSending) {
                    setTimeout(() => sendNextFileFromQueue(), 500);
                }
            }
            
            function startHeartbeat() {
                stopHeartbeat();
                heartbeatInterval = setInterval(() => {
                    if (currentConnection && currentConnection.open) {
                        try {
                            currentConnection.send({ type: 'heartbeat-ping' });
                        } catch (e) {}
                    }
                }, 5000);
            }

            function stopHeartbeat() {
                if (heartbeatInterval) {
                    clearInterval(heartbeatInterval);
                    heartbeatInterval = null;
                }
            }
            
            function handleDisconnect(message) {
                console.log('âš  Disconnect:', message);
                stopHeartbeat();
                
                // Set a flag to prevent multiple reloads
                if (IS_RELOADING) return;
                IS_RELOADING = true;

                statusEl.textContent = 'âš ï¸ Disconnected... Reloading...';
                
                if (currentConnection) {
                    try { currentConnection.close(); } catch (e) {}
                    currentConnection = null;
                }
                if (peer && !peer.destroyed) {
                    try { peer.destroy(); } catch (e) {}
                    peer = null;
                }
                
                // Disconnected. Clear the hash and reload.
                // The app will re-initialize in HOST mode.
                console.log('ğŸ”„ Reverting to host mode by reloading...');
                window.location.hash = '';
                window.location.reload();
            }

            fileInput.addEventListener('change', (event) => {
                for (const file of event.target.files) {
                    fileQueue.push(file);
                }
                event.target.value = null; // Clear input
                transferStatusEl.textContent = `ğŸ“ ${fileQueue.length} queued`;
                
                if (currentConnection && currentConnection.open && !isSending) {
                    sendNextFileFromQueue();
                }
            });

            function sendNextFileFromQueue() {
                if (fileQueue.length === 0) {
                    isSending = false;
                    hasActiveTransfer = false;
                    transferStatusEl.textContent = 'âœ… All sent!';
                    return;
                }
                
                if (!currentConnection || !currentConnection.open || isSending) return;
                
                isSending = true;
                hasActiveTransfer = true;
                cancelTransfer = false;
                const file = fileQueue.shift();
                
                transferStatusEl.textContent = `ğŸ“¤ ${file.name}`;
                progressContainer.style.display = 'block';
                
                const startTime = Date.now();

                try {
                    currentConnection.send({
                        type: 'metadata',
                        name: file.name,
                        size: file.size,
                        fileType: file.type
                    });
                } catch (e) {
                    handleDisconnect('Send failed');
                    return;
                }

                let offset = 0;
                const reader = new FileReader();

                reader.onload = (e) => {
                    if (cancelTransfer) {
                        isSending = false;
                        hasActiveTransfer = false;
                        fileQueue = []; // Clear queue
                        progressContainer.style.display = 'none';
                        transferStatusEl.textContent = 'âŒ Cancelled';
                        if(currentConnection && currentConnection.open) {
                             try {
                                 currentConnection.send({ type: 'cancel' });
                             } catch (err) {}
                        }
                        return;
                    }
                    
                    if(!currentConnection || !currentConnection.open) {
                        isSending = false;
                        hasActiveTransfer = false;
                        // Don't call handleDisconnect here, it will be called by conn.on('close')
                        console.error("Connection lost during sending");
                        return;
                    }
                
                    try {
                        currentConnection.send(e.target.result); // Send ArrayBuffer
                        offset += e.target.result.byteLength;
                        updateProgress(offset, file.size, startTime);

                        if (offset < file.size) {
                            readSlice(offset);
                        } else {
                            currentConnection.send({ type: 'end' });
                            isSending = false;
                            progressContainer.style.display = 'none';

                            // Show notification
                            showNotification('Upload Complete', {
                                body: file.name,
                                icon: 'https://cdn-icons-png.flaticon.com/128/709/709664.png' // Checkmark icon
                            });

                            sendNextFileFromQueue(); // Send next file
                        }
                    } catch (err) {
                        console.error("Send error:", err);
                        // Don't call handleDisconnect, let the error handler do it
                    }
                };
                
                reader.onerror = (e) => {
                    isSending = false;
                    hasActiveTransfer = false;
                    transferStatusEl.textContent = 'âŒ File Read error';
                    progressContainer.style.display = 'none';
                };

                function readSlice(o) {
                    const slice = file.slice(o, o + CHUNK_SIZE);
                    reader.readAsArrayBuffer(slice);
                }
                
                readSlice(0);
            }
            
            function updateProgress(sentBytes, totalBytes, startTime) {
                const percent = Math.round((sentBytes / totalBytes) * 100);
                progressBar.style.width = `${percent}%`;
                progressPercentage.textContent = `${percent}%`;
                progressSize.textContent = `${formatBytes(sentBytes)} / ${formatBytes(totalBytes)}`;
                updateDeliveryBoy(percent);
                
                // Update notification (throttled to every 10%)
                if (percent % 10 === 0) {
                    showNotification('Uploading...', {
                        body: `${formatBytes(sentBytes)} / ${formatBytes(totalBytes)} (${percent}%)`,
                        icon: 'https://cdn-icons-png.flaticon.com/128/1828/1828784.png' // Upload icon
                    });
                }

                const elapsedTime = (Date.now() - startTime) / 1000;
                if (elapsedTime > 0.5) {
                    const speed = sentBytes / elapsedTime;
                    const remainingBytes = totalBytes - sentBytes;
                    const remainingTime = remainingBytes / speed;
                    progressEta.textContent = `ETA: ${formatTime(remainingTime)}`;
                }
            }

            function formatBytes(bytes, decimals = 2) {
                if (bytes === 0) return '0 B';
                const k = 1024;
                const dm = decimals < 0 ? 0 : decimals;
                const sizes = ['B', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
            }
            
            function formatTime(seconds) {
                if (seconds === Infinity || isNaN(seconds)) return '--:--';
                const min = Math.floor(seconds / 60);
                const sec = Math.floor(seconds % 60);
                return `${min}:${sec < 10 ? '0' : ''}${sec}`;
            }

            cancelButton.addEventListener('click', () => {
                cancelTransfer = true;
                // Show notification
                showNotification('Upload Cancelled', {
                    body: 'The file transfer was cancelled.',
                    icon: 'https://cdn-icons-png.flaticon.com/128/1828/1828843.png' // Error icon
                });
            });

            function setupShareButton() {
                const canvas = qrEl.querySelector('canvas');
                if (!canvas || typeof navigator.share === 'undefined') {
                    nativeShareButton.style.display = 'none';
                    copyLinkButton.style.display = 'inline-flex';
                    downloadQrButton.style.display = 'inline-flex';
                    return;
                }

                canvas.toBlob((blob) => {
                    if (!blob) {
                        nativeShareButton.style.display = 'none';
                        copyLinkButton.style.display = 'inline-flex';
                        downloadQrButton.style.display = 'inline-flex';
                        return;
                    }
                    
                    const file = new File([blob], 'qr-code.png', { type: 'image/png' });
                    const shareData = {
                        title: 'QR Send',
                        text: 'Scan to connect',
                        url: connectUrl,
                        files: [file]
                    };

                    if (navigator.canShare && navigator.canShare(shareData)) {
                        nativeShareButton.style.display = 'inline-flex';
                        copyLinkButton.style.display = 'none';
                        downloadQrButton.style.display = 'none';
                        nativeShareButton.onclick = async () => {
                            try {
                                await navigator.share(shareData);
                            } catch (err) {}
                        };
                    } else {
                        nativeShareButton.style.display = 'none';
                        copyLinkButton.style.display = 'inline-flex';
                        downloadQrButton.style.display = 'inline-flex';
                    }
                }, 'image/png');
            }

            function copyToClipboard(text, element) {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    if(element) {
                        const originalText = element.textContent;
                        element.textContent = 'âœ… Copied!';
                        setTimeout(() => {
                            element.textContent = originalText;
                        }, 1500);
                    }
                } catch (err) {}
                document.body.removeChild(textarea);
            }
            
            function downloadQRCode() {
                try {
                    const canvas = qrEl.querySelector('canvas');
                    if (canvas) {
                        const dataUrl = canvas.toDataURL('image/png');
                        const a = document.createElement('a');
                        a.href = dataUrl;
                        a.download = 'qr-send.png';
                        document.body.appendChild(a);
                        a.click();
                        a.remove();
                    }
                } catch (e) {}
            }

            copyLinkButton.addEventListener('click', () => {
                if (connectUrl) copyToClipboard(connectUrl, copyLinkButton);
            });
            
            downloadQrButton.addEventListener('click', downloadQRCode);
            // ---

            // Start the app
            initializePeer();
        });
    </script>
</body>
</html>

